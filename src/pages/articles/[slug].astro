---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import {
  buildBibtex,
  buildCitation,
  formatArticleDate,
  formatAuthors,
  sortArticlesDesc,
  type ArticleEntry,
} from "../../lib/articles";
import { EDITOR_EMAIL, PAY_QR_PUBLIC_FILE, hasPayQrImage } from "../../lib/contact";
import { withBase } from "../../lib/paths";

interface Props {
  article: ArticleEntry;
}

export async function getStaticPaths() {
  const articles = (await getCollection("articles")).sort(sortArticlesDesc);

  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props as Props;
const isNonOA = article.data.accessRoute === "Non-OA";
const renderedArticle = isNonOA ? null : await article.render();
const Content = renderedArticle?.Content;

const citation = buildCitation(article);
const bibtex = buildBibtex(article);

const allColumns = await getCollection("columns");
const columnTitleBySlug = new Map(allColumns.map((column) => [column.slug, column.data.title]));
---

<SiteLayout title={article.data.title} description={article.data.abstract}>
  <section class="page-head">
    <div class="container">
      <div class="panel article-header-card">
        <span class="eyebrow">Article</span>

        {article.data.demo && (
          <div class="notice" style="margin-top: 0.6rem;">
            <strong>DEMO CONTENT - fictional / illustrative. Not peer-reviewed.</strong>
            <p>{article.data.demoNote ?? "Demo article for interface and workflow testing."}</p>
          </div>
        )}

        <div class="article-actions">
          <span class="badge badge--type">{article.data.articleType}</span>
          <span class={`badge ${article.data.accessRoute === "OA" ? "badge--oa" : "badge--non-oa"}`}>
            {article.data.accessRoute}
          </span>
          {article.data.demo && <span class="badge">DEMO</span>}
        </div>

        {article.data.columns.length > 0 && (
          <div class="article-actions" aria-label="Column assignments">
            {article.data.columns.map((columnSlug) => (
              <a
                class="badge badge--type"
                href={withBase(`columns/${columnSlug}/`)}
                style="text-decoration: none;"
                title={`Column: ${columnTitleBySlug.get(columnSlug) ?? columnSlug}`}
              >
                {columnTitleBySlug.get(columnSlug) ?? columnSlug}
              </a>
            ))}
          </div>
        )}

        <h1 class="article-title">{article.data.title}</h1>
        <p class="article-submeta">{formatAuthors(article.data.authors)}</p>
        <p class="article-submeta">Published {formatArticleDate(article.data.published)}</p>

        <div class="article-abstract">
          <span class="eyebrow">Abstract</span>
          <p>{article.data.abstract}</p>
          {article.data.demo && (
            <p class="article-submeta">
              Demo article - fictional content used to demonstrate layout.
            </p>
          )}
        </div>

        {article.data.contentWarning && (
          <div class="notice" style="margin-top: 0.9rem;">
            <strong>Content note</strong>
            <p>{article.data.contentWarning}</p>
          </div>
        )}

        <div class="article-actions" aria-label="Article actions">
          {article.data.pdfUrl ? (
            <a class="button" href={article.data.pdfUrl} target="_blank" rel="noreferrer">
              Download PDF
            </a>
          ) : (
            <button class="button" type="button" disabled>
              Download PDF
            </button>
          )}
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container content-columns">
      {isNonOA ? (
        <article class="panel prose-panel">
          <div class="prose">
            <h2>Membership required for full text</h2>
            <p>
              This article is published under the <strong>Non-OA</strong> route. The journal demo keeps full metadata,
              abstract, citation tools, and indexing information public, but the article body is gated.
            </p>
            <p>
              Use the membership options page to review the current demo pricing model and unlock access logic.
            </p>
            <ul>
              <li><strong>Non-OA reader membership:</strong> $9.9/month</li>
              <li><strong>Sponsor us lifetime membership:</strong> $29.9 one-time</li>
              <li><strong>OA publishing fee (APC):</strong> $9.9 one-time (paid by authors)</li>
            </ul>
            <div class="cta-row">
              <a class="button" href={withBase("membership/")}>View membership options</a>
              <a class="button button--secondary" href={withBase("articles/")}>Browse other articles</a>
            </div>

            <div class="panel panel--padded" style="margin-top: 0.9rem;">
              <h3>Support / Payment</h3>
              <p>
                Demo patronage UI for a method-serious, topic-unserious journal. Support is framed as patronage for
                editorial labor and curation, not real subscription billing infrastructure.
              </p>
              <p>
                If you pay, email a screenshot plus your GitHub username/identifier. If you cannot pay, email the
                editor. We still expect ethics, consent, non-harm, and defensive research framing in submissions.
              </p>
              <p>
                Or contact the Editor-in-Chief: <a href={`mailto:${EDITOR_EMAIL}`}>{EDITOR_EMAIL}</a>
              </p>

              {hasPayQrImage ? (
                <img
                  src={withBase(PAY_QR_PUBLIC_FILE)}
                  alt="Support or patronage QR code for the demo journal"
                  width="220"
                  height="220"
                  loading="lazy"
                  style="margin-top: 0.5rem; border-radius: 12px; border: 1px solid var(--line); background: white;"
                />
              ) : (
                <div class="notice" style="margin-top: 0.75rem;">
                  <strong>QR image missing</strong>
                  <p>
                    Place the file at <span class="inline-code">public/payments/qr.png</span> to display the support
                    QR code.
                  </p>
                </div>
              )}

              <p class="article-submeta" style="margin-top: 0.75rem;">
                Demo disclaimer: this page does not process real payments, access is not automatically provisioned,
                and no sensitive payment data is collected.
              </p>
            </div>
          </div>
        </article>
      ) : (
        <article class="panel prose-panel">
          <div class="prose">
            {Content && <Content />}
          </div>
        </article>
      )}

      <aside class="panel info-card">
        <div>
          <h2>Article metadata</h2>
          <dl class="meta-grid">
            <div class="meta-item">
              <dt>Received</dt>
              <dd>{article.data.received ? formatArticleDate(article.data.received) : "Not provided"}</dd>
            </div>
            <div class="meta-item">
              <dt>Accepted</dt>
              <dd>{article.data.accepted ? formatArticleDate(article.data.accepted) : "Not provided"}</dd>
            </div>
            <div class="meta-item">
              <dt>Published</dt>
              <dd>{formatArticleDate(article.data.published)}</dd>
            </div>
            <div class="meta-item">
              <dt>Article type</dt>
              <dd>{article.data.articleType}</dd>
            </div>
            <div class="meta-item">
              <dt>Access route</dt>
              <dd>{article.data.accessRoute}</dd>
            </div>
            <div class="meta-item">
              <dt>Columns</dt>
              <dd>
                {article.data.columns.length > 0 ? (
                  <ul class="keyword-list">
                    {article.data.columns.map((columnSlug) => (
                      <li>
                        <a href={withBase(`columns/${columnSlug}/`)}>
                          {columnTitleBySlug.get(columnSlug) ?? columnSlug}
                        </a>
                      </li>
                    ))}
                  </ul>
                ) : (
                  "None"
                )}
              </dd>
            </div>
            <div class="meta-item">
              <dt>Content note</dt>
              <dd>{article.data.contentWarning ?? "None"}</dd>
            </div>
            <div class="meta-item">
              <dt>License</dt>
              <dd>{article.data.license ?? "Not specified"}</dd>
            </div>
            <div class="meta-item">
              <dt>Keywords</dt>
              <dd>
                <ul class="keyword-list">
                  {article.data.keywords.map((keyword) => (
                    <li>{keyword}</li>
                  ))}
                </ul>
              </dd>
            </div>
          </dl>
        </div>

        <div class="copy-tools" data-copy-tools>
          <h2>Citation tools</h2>
          <p>Copy a plain-text citation or a generated BibTeX entry for reference managers.</p>

          <div class="copy-row">
            <button class="button button--secondary" type="button" data-copy-kind="citation">
              Copy citation
            </button>
            <button class="button button--secondary" type="button" data-copy-kind="bibtex">
              Copy BibTeX
            </button>
          </div>

          <p class="copy-status" data-copy-status aria-live="polite"></p>

          <template id="citation-template">{citation}</template>
          <template id="bibtex-template">{bibtex}</template>
        </div>

        <div>
          <a class="back-link" href={withBase("articles/")}>{"<-"} Back to archive</a>
        </div>
      </aside>
    </div>
  </section>

  <script is:inline>
    (() => {
      const root = document.querySelector("[data-copy-tools]");
      if (!root) {
        return;
      }

      const status = root.querySelector("[data-copy-status]");
      const citationTemplate = document.getElementById("citation-template");
      const bibtexTemplate = document.getElementById("bibtex-template");
      const buttons = Array.from(root.querySelectorAll("[data-copy-kind]"));

      const texts = {
        citation: citationTemplate ? citationTemplate.textContent?.trim() || "" : "",
        bibtex: bibtexTemplate ? bibtexTemplate.textContent?.trim() || "" : "",
      };

      const fallbackCopy = (text) => {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        textarea.remove();
      };

      const writeClipboard = async (text) => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }

        fallbackCopy(text);
      };

      for (const button of buttons) {
        button.addEventListener("click", async () => {
          const kind = button.getAttribute("data-copy-kind");
          if (!kind || !(kind in texts)) {
            return;
          }

          try {
            await writeClipboard(texts[kind]);
            if (status) {
              status.textContent = kind === "citation" ? "Citation copied." : "BibTeX copied.";
            }
          } catch {
            if (status) {
              status.textContent = "Copy failed. Select and copy manually.";
            }
          }
        });
      }
    })();
  </script>
</SiteLayout>
