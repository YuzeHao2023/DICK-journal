---
import { getCollection } from "astro:content";
import ArticleCard from "../../components/ArticleCard.astro";
import SiteLayout from "../../layouts/SiteLayout.astro";
import { sortArticlesDesc } from "../../lib/articles";

const articles = (await getCollection("articles")).sort(sortArticlesDesc);

const articleTypes = [...new Set(articles.map((article) => article.data.articleType))];
const accessRoutes = [...new Set(articles.map((article) => article.data.accessRoute))];
---

<SiteLayout
  title="Articles"
  description="Archive of DICK journal demo articles with filters for article type and access route."
>
  <section class="page-head">
    <div class="container">
      <div class="panel page-head__panel">
        <span class="eyebrow">Archive</span>
        <h1>Article archive</h1>
        <p>
          Browse research, methods, and replication articles. Use the filter chips to narrow by article type
          and access route without reloading the page.
        </p>

        <div class="chip-toolbar" aria-label="Archive filters">
          <div class="chip-group" role="group" aria-label="Filter by article type">
            <span class="chip-label">Article type</span>
            <button class="filter-chip" type="button" data-filter-group="type" data-filter-value="all" aria-pressed="true">
              All types
            </button>
            {articleTypes.map((articleType) => (
              <button
                class="filter-chip"
                type="button"
                data-filter-group="type"
                data-filter-value={articleType}
                aria-pressed="false"
              >
                {articleType}
              </button>
            ))}
          </div>

          <div class="chip-group" role="group" aria-label="Filter by access route">
            <span class="chip-label">Access route</span>
            <button class="filter-chip" type="button" data-filter-group="route" data-filter-value="all" aria-pressed="true">
              All access
            </button>
            {accessRoutes.map((route) => (
              <button
                class="filter-chip"
                type="button"
                data-filter-group="route"
                data-filter-value={route}
                aria-pressed="false"
              >
                {route}
              </button>
            ))}
          </div>
        </div>

        <p id="archive-status" class="archive-status">
          Showing {articles.length} of {articles.length} articles
        </p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div id="archive-grid" class="article-grid archive-grid">
        {articles.map((article) => (
          <div data-archive-card data-type={article.data.articleType} data-route={article.data.accessRoute}>
            <ArticleCard article={article} />
          </div>
        ))}
      </div>
    </div>
  </section>

  <script is:inline>
    (() => {
      const buttons = Array.from(document.querySelectorAll("[data-filter-group]"));
      const cards = Array.from(document.querySelectorAll("[data-archive-card]"));
      const status = document.getElementById("archive-status");

      if (!buttons.length || !cards.length || !status) {
        return;
      }

      const state = {
        type: "all",
        route: "all",
      };

      const pluralize = (count) => (count === 1 ? "article" : "articles");

      const render = () => {
        let visible = 0;

        for (const card of cards) {
          const cardType = card.getAttribute("data-type") || "";
          const cardRoute = card.getAttribute("data-route") || "";
          const typeMatch = state.type === "all" || cardType === state.type;
          const routeMatch = state.route === "all" || cardRoute === state.route;
          const shouldShow = typeMatch && routeMatch;

          card.hidden = !shouldShow;
          if (shouldShow) {
            visible += 1;
          }
        }

        status.textContent = `Showing ${visible} of ${cards.length} ${pluralize(cards.length)}`;
      };

      const updateButtons = () => {
        for (const button of buttons) {
          const group = button.getAttribute("data-filter-group");
          const value = button.getAttribute("data-filter-value");
          const isPressed = group && value ? state[group] === value : false;
          button.setAttribute("aria-pressed", String(isPressed));
        }
      };

      for (const button of buttons) {
        button.addEventListener("click", () => {
          const group = button.getAttribute("data-filter-group");
          const value = button.getAttribute("data-filter-value");

          if (!group || !value) {
            return;
          }

          state[group] = value;
          updateButtons();
          render();
        });
      }

      updateButtons();
      render();
    })();
  </script>
</SiteLayout>
